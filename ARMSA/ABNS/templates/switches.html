{% extends "base.html" %}
{% load filterfortree %}
{% block content %}
<div id="menu-buttons">
<table class="menu-table">
        <tr>
            {% with a=st_id|add:"/"|add:ho_id%}
            {% with n="users/"|add:a %}
            <td><a href="." class="menu-grey-button" rel="menu" name={{ n }}>Пользователи</a></td>
            {% endwith %}
            {% with n="ports/"|add:a %}
            <td><a href="." class="menu-grey-button" rel="menu" name={{ n }}>Порты</a></td>
            {% endwith %}
            {% with n="switches/"|add:a %}
            <td><a href="." class="menu-grey-button" rel="menu" name={{ n }}>Коммутаторы</a></td>
            {% endwith %}
            {% with n="macs/"|add:a %}
            <td><a href="." class="menu-grey-button" rel="menu" name={{ n }}>MAC</a></td>
            {% endwith %}
            {% endwith %}
        </tr>
    </table>
</div>
<div id="table-div">
{% for switch in sw_query %}
<b>{{ switch.sw_ip }}</b>
<table class="users-table" id="usertable">
    <tr>
        <td>Порт</td>
        <td>Статус порта</td>
        <td>Состояние линка</td>
        <td>Доверенный</td>
        <td>Адрес</td>
        <td>Состояние порта</td>
        <td>Примечание</td>
        <td>Изменить</td>
        <td>PortSecurity</td>
    </tr>
    {% with portnumber=switch.sw_ip|get_portnumber:ports %}
    {% for iport in portnumber|times %}
        {% with port=iport|add:1 %}
            <tr class="table-row">
            <td> {{ port }} </td>
            

            {% with switch_ip=switch.sw_ip %}
                {% with sw_ping=switch_ip|check_sw:pings %}
                    {% if sw_ping %}
                        {% with pp=port|stringformat:"d" %}
                            {% with p=switch_ip|add:":"|add:pp %}
                                {% if p|check_port:status_ports == True %}
                                    <td><label id="yeslbl"><input type="checkbox" id="portstatus" name={{ p|add:":"|add:switch.street|add:":"|add:switch.house }} checked="checked" />UP</label></td>
                                {% else %}
                                    <td><label id="nolbl"><input type="checkbox" id="portstatus" name={{ p|add:":"|add:switch.street|add:":"|add:switch.house }} />DOWN</label></td>
                                {% endif %}
                            {% endwith %}
                        {% endwith %}
                    {% else %}
                        <td><label id="nolbl"><input type="checkbox" id="portstatus" name={{ p|add:":"|add:switch.street|add:":"|add:switch.house }} />DOWN</label></td>
                    {% endif %}
                        
                    {% if sw_ping %}
                        {% with pp=port|stringformat:"d" %}
                            {% with p=switch_ip|add:":"|add:pp %}
                                {% if p|check_link:status_links == True %}
                                    <td><label id="yeslbl">UP</label></td>
                                {% else %}
                                    <td><label id="nolbl">DOWN</label></td>
                                {% endif %}
                            {% endwith %}
                        {% endwith %}
                    {% else %}
                        <td><label id="nolbl">DOWN</label></td>
                    {% endif %}

                    {% with pp=port|stringformat:"d" %}
                        {% with p=switch_ip|add:":"|add:pp %}
                            {% if p|check_trust:status_trust %}
                                <td><label id="yeslbl"><input type="checkbox" id="trust" name={{ p|add:":"|add:switch.street|add:":"|add:switch.house }} checked="checked" />ДА</label></td>
                            {% else %}
                                <td><label id="nolbl"><input type="checkbox" id="trust" name={{ p|add:":"|add:switch.street|add:":"|add:switch.house }} />НЕТ</label></td>
                            {% endif %}
                        {% endwith %}
                    {% endwith %}

                    {% with pp=port|stringformat:"d" %}
                        {% with p=switch_ip|add:":"|add:pp %}
                            {% with address=p|get_address:port_address %}
                                <td><b><center>{{ address }}</center></b></td>
                            {% endwith %}
                        {% endwith %}
                    {% endwith %}

                    {% with r=port|stringformat:"d" %}
                        <form action='.' method="post" id={{ switch.sw_ip|add:':'|add:r }}>
                    {% endwith %}

                    {% csrf_token %}
                    <input type="hidden" name="sn" value={{ switch.sw_sn }}>
                    <input type="hidden" name="port" value={{ port }}>
                    <td>
                    <select name="type">
                        {% for type in port_types %}
                            {% with pp=port|stringformat:"d" %}
                                {% with p=switch_ip|add:":"|add:pp %}
                                    {% with t=p|get_type:port_type %}
                                        {% if t == type.sw_info %}
                                            <option value={{ type.sw_info }} selected="selected">{{ type.sw_info }}</option>
                                        {% else %}
                                            <option value={{ type.sw_info }}>{{ type.sw_info }}</option>
                                        {% endif %}
                                    {% endwith %}
                                {% endwith %}
                            {% endwith %}
                        {% endfor %}
                    </select>
                    </td>

                    {% with pp=port|stringformat:"d" %}
                        {% with p=switch_ip|add:":"|add:pp %}
                            {% with memo=p|get_memo:port_memo %}
                                <td><INPUT type="text" name="memo" maxlength="5" value={{ memo }}></td>
                            {% endwith %}
                        {% endwith %}
                    {% endwith %}

                    {% with r=port|stringformat:"d" %}
                        <td><a href="." class="flat-grey-button" name={{ switch.sw_ip|add:':'|add:r|add:'/'|add:switch.street|add:'/'|add:switch.house }} rel="chg">Изменить</a></td>
                    {% endwith %}

                    </form>

                    {% with r=forloop.counter|stringformat:"d" %}
                        <td><a href="." class="flat-grey-button" name={{ r }} rel="portsec">PortSecurity</a></td>
                    {% endwith %}


                {% endwith %}
            {% endwith %}
        {% endwith %}
        </tr>
    {% endfor %}
    {% endwith %}
</table>
<br>

{% endfor %}
</div>
{% endblock %}


{% block javascript %}
<script language="javascript" type="text/javascript">
    $("a[rel^='menu']").click(function (event) {
        event.preventDefault();
        var key = $(this).attr("name");
        var k = key.split("/");

        switch(k[0]){
            case "users":
                var path="//127.0.0.1:8000/clients/"+k[1]+"/"+k[2]+"/";
                break;

            case "ports":
                var path="//127.0.0.1:8000/ports/"+k[1]+"/"+k[2]+"/";
                break; 

            case "switches":
                var path="//127.0.0.1:8000/switches/"+k[1]+"/"+k[2]+"/";
                break;

            case "macs":
                var path="//127.0.0.1:8000/macs/"+k[1]+"/"+k[2]+"/";
                break; 
        }
        $("#content").load(path);
    });

    $("a[rel^='chg']").click(function (event) {
        event.preventDefault();
        // console.log($(this).attr("name"));
        var addr = $(this).attr("name").split('/');
        var t = 'form[id="'+addr[0]+'"]';
        //var n = $(this).parents().find("form").find($(this).attr("name")).attr("name");
        var n = $(t).attr("id");
        // console.log(n);
        //var addr = n.split("/");
        var data = $(t).serialize();
        // console.log(data);
        var action = confirm('Вы уверены, что желаете внести изменения?');
        if(action){
            $.post( "//127.0.0.1:8000/switches/", data, function() {
                $("#content").load("//127.0.0.1:8000/switches/"+addr[1]+'/'+addr[2]+'/');
            });
        }
    });

    $("input[id='portstatus']").change(function (event) {
        var n = ($(this).attr("name")).split(":");
        if (this.checked){
            var data = "sw="+n[0]+"&port="+n[1]+"&act=open";
            $.get( "//127.0.0.1:8000/portaction/", data, function() {
                $("#content").load("//127.0.0.1:8000/switches/"+n[2]+'/'+n[3]+'/');
            });
        }
        else {
            var data = "sw="+n[0]+"&port="+n[1]+"&act=close";
            $.get( "//127.0.0.1:8000/portaction/", data, function() {
                $("#content").load("//127.0.0.1:8000/switches/"+n[2]+'/'+n[3]+'/');
            });
        }
    });

    $("input[id='trust']").change(function (event) {
        var n = ($(this).attr("name")).split(":");
        if (this.checked){
            var data = "sw="+n[0]+"&port="+n[1]+"&act=check";
            $.get( "//127.0.0.1:8000/trustaction/", data, function() {
                $("#content").load("//127.0.0.1:8000/switches/"+n[2]+'/'+n[3]+'/');
            });
        }
        else {
            var data = "sw="+n[0]+"&port="+n[1]+"&act=uncheck";
            $.get( "//127.0.0.1:8000/trustaction/", data, function() {
                $("#content").load("//127.0.0.1:8000/switches/"+n[2]+'/'+n[3]+'/');
            });
        }
    });

</script>
{% endblock %}